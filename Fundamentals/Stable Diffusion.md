## Stable Diffusion

#### DDPMåŸç†

ä»$X_0$ï¼ˆè¾“å…¥çš„è‡ªç„¶å›¾ç‰‡ï¼‰åˆ°$X_T$ï¼ˆåŠ äº†å¾ˆå¤šå™ªå£°çš„çº¯å™ªéŸ³ï¼‰çš„åŠ å™ªè¿‡ç¨‹æˆ‘ä»¬æˆä¸ºå‰å‘è¿‡ç¨‹ï¼ˆforward processï¼‰ï¼Œ

ä»$X_T$åˆ°$X_0$çš„å»å™ªè¿‡ç¨‹æˆ‘ä»¬æˆä¸ºåå‘è¿‡ç¨‹ï¼ˆreverse process/inversionï¼‰

é€šè¿‡å‰å‘è¿‡ç¨‹æˆ‘ä»¬æƒ³è¦å¾—åˆ°ä¸€ä¸ª$X_T$æ‰€æœ‰å¯èƒ½çš„**åˆ†å¸ƒ**æ¦‚ç‡â€”$X_T \sim N(0,1)$ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªç¡®åˆ‡çš„$X_T$ï¼Œç„¶åä»ä¸­å–å‡ºä¸€ä¸ª$X_{T}^{'}\rightarrow X_0^{'}$ï¼Œ$X_0{'}$å°±æ˜¯æˆ‘ä»¬çš„ç›®æ ‡â€”ç”Ÿæˆå‡ºæ¥çš„ä¸åŸå›¾ä¸åŒçš„å…·æœ‰åˆ›æ–°æ€§çš„æ–°å›¾ç‰‡ï¼ˆgenerated by DDPM and different from the original picture ,a new imageï¼‰ã€‚

å¯¹äºåå‘è¿‡ç¨‹ä¸­ä¸­çš„æŸä¸€step$X_t$ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯å¾—åˆ°$X_{t-1}$çš„åˆ†å¸ƒ$P(X_{t-1}|X_t)$è€Œä¸æ˜¯ä¸€ä¸ªç¡®å®šçš„$X_{t-1}$â€‹ï¼Œå› ä¸ºè¿™æ ·æˆ‘ä»¬å¯ä»¥ä»å¾—åˆ°çš„åˆ†å¸ƒä¸­éšæœºæŠ½å–ä¸€ä¸ªæ ·æœ¬ï¼Œä»è€Œå…·æœ‰éšæœºæ€§ã€‚éšæœºæ€§å¯¹äºç”Ÿæˆæ¨¡å‹æ˜¯éå¸¸é‡è¦çš„ï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›ç”Ÿæˆçš„å›¾ç‰‡ä¸åŸå›¾æ˜¯ä¸ä¸€æ ·çš„ã€‚

>  æ‰€è°“åˆ†å¸ƒï¼Œå¯ä»¥æŠŠå®ƒç†è§£æˆå¯¹äºeach pixelï¼Œå…¶å–å€¼çš„å¯èƒ½æ€§é›†åˆã€‚å¦‚14x14çš„å›¾ç‰‡æˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°ä¸€ä¸ª196ç»´çš„åˆ†å¸ƒï¼Œé‚£æˆ‘ä»¬sampleçš„æ—¶å€™å°±ä¼šæ ¹æ®æ¯ä¸ªpixelè½åœ¨ä¸åŒåŒºé—´çš„æ¦‚ç‡ï¼Œå½“åšæƒé‡å»ç»™æ¯ä¸ªpixelèµ‹å€¼ã€‚

æ‰€ä»¥æˆ‘ä»¬åå‘è¿‡ç¨‹ä¸€æ­¥æ­¥denoiseçš„ç›®æ ‡å°±æ˜¯æ±‚$P(X_{t-1}|X_t),tâˆˆ[0,steps]$ï¼Œéœ€è¦æ±‚1000ä¸ªåˆ†å¸ƒã€‚
$$
P(X_{t-1}|X_t)=\frac{P(X_t,X_{t-1})}{P(X_t)}=\frac{P(X_t|X_{t-1})P(X_{t-1})}{P(X_t)}
$$
é‚£ä¹ˆè¿™ä¸ª$P(X_t|X_{t-1})$å®é™…ä¸Šå°±æ˜¯forward processï¼Œæ·»åŠ å™ªå£°çš„è¿‡ç¨‹ï¼Œé‚£æˆ‘ä»¬å…·ä½“æ€ä¹ˆæ·»åŠ å™ªå£°å‘¢ï¼Ÿ

åˆ©ç”¨å¦‚ä¸‹å…¬å¼æ·»åŠ ï¼š
$$
X_t=\sqrt{a_t}X_{t-1}+\sqrt{\beta_t} \epsilon,\epsilon\sim N(0,1)
$$
$\beta_t=1-a_t$ï¼Œé‚£ä¹ˆ$\sqrt{\beta_t}\epsilon\sim N(0,\beta_t)$ï¼Œæˆ‘ä»¬è§„å®š$\beta_t$ä¸€å®šéå¸¸å°ï¼Œè¶‹äº0
$$
\therefore X_t\sim N(\sqrt{a_t}X_{t-1},\beta_t)
$$
æ‰€ä»¥æˆ‘ä»¬å°±æ‹¿åˆ°äº†$X_t$çš„æ¦‚ç‡åˆ†å¸ƒ$P(X_t|X_{t-1})$â€”â€”â€”â€”$P(X_t|X_{t-1})\sim N(\sqrt{a_t}X_{t-1},\beta_t)$

é‚£**ï¼ˆ1ï¼‰**ä¸­çš„$P(x-1)$æ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬å¯ä»¥æ ¹æ®ğŸ‘†çš„é€’æ¨å¼ä¸€æ­¥ä¸€æ­¥æ¨å‡ºæ¥ï¼Œç›¸å½“äº$P(X_{x-1}|X_0)$

å³ï¼š
$$
P(X_{t-1})\rightarrow P(X_{t-1}|X_{0})\\
P(X_t)\rightarrow P(X_{t}|X_0)
$$
é‚£è®©æˆ‘ä»¬é‡å†™ä¸€ä¸‹**ï¼ˆ1ï¼‰**å¼å§ï¼ï¼ï¼ï¼
$$
P(X_{t-1}|X_t,X_0)=\frac{P(X_t,X_{t-1},X_0)}{P(X_t)}=\frac{P(X_t|X_{t-1},X_0)P(X_{t-1}|X_0)}{P(X_t|X_0)}
$$
ä½†æ˜¯DDPMæœ‰ä¸€ä¸ªå¤§å‰æï¼æˆ–è€…è¯´å‡è®¾ï¼šæ•´ä¸ªè¿‡ç¨‹ç¬¦åˆ**é©¬å°”ç§‘å¤«è¿‡ç¨‹**ï¼å°±æ˜¯å½“å‰çŠ¶æ€åªè·Ÿä¸Šä¸€ä¸ªçŠ¶æ€æœ‰å…³ï¼Œè·Ÿå†ä¹‹å‰çš„çŠ¶æ€æ²¡æœ‰ä»»ä½•å…³ç³»ï¼ï¼ï¼

æ‰€ä»¥**ï¼ˆ5ï¼‰**ä¸­çš„$P(X_{t}|X_{t-1}X_0)$å°±å¯ä»¥å»æ‰$X_0$ï¼------>$P(X_t|X_{t-1})$

é‚£$P(X_{t-1}|X_0)$å‘¢ï¼Ÿå› ä¸ºè¿™é‡Œæ²¡æœ‰$X_{t-2}$ï¼Œæ‰€ä»¥è¿™ä¸ª$X_0$ä¸èƒ½å»ã€‚ä½†æ˜¯æˆ‘ä»¬æ€è€ƒä¸€ä¸‹ä»$X_0$åˆ°$X_{t-1}$æ˜¯æ€ä¹ˆæ¥çš„ï¼Ÿ
$$
X_{t-1}=\sqrt{a_{t-1}}X_{t-2}+\sqrt{\beta_{t-1}}\epsilon_{t-1}\\
\because X_{t-2}=\sqrt{a_{t-2}}X_{t-3}+\sqrt{\beta_{t-2}}\epsilon_{t-2}\\
æˆ‘ä»¬å¸¦è¿›å»ï¼š\\
X_{t-1}=\sqrt{a_{t-1}}(\sqrt{a_{t-2}}X_{t-3}+\sqrt{\beta_{t-2}}\epsilon_{t-2})+\sqrt{\beta_{t-1}}\epsilon_{t-1}\\
X_{t-1}=\sqrt{a_{t-1}a_{t-2}}X_{t-3}+(\sqrt{a_{t-1}\beta_{t-2}}\epsilon_{t-2}+\sqrt{\beta_{t-1}}\epsilon_{t-1})\\
n\ steps\ later\ ......\\
X_{t-1}=\sqrt{a_{t-1}a_{t-2}...a_{1}}X_0+C\epsilon^{'},\epsilon'æ˜¯å„ä¸ªstepçš„\epsilonçš„çº¿æ€§ç»„åˆï¼Œ\epsilon^{'}\sim N(0,1)\\
\therefore X_{t-1}\sim N(\sqrt{a_{t-1}a_{t-2}...a_1}X_0,1-\sqrt{a_{t-1}a_{t-2}...a_1})\\
ä»¤\bar{a}_{t-1}=a_{t-1}a_{t-2}...a_1\\
\therefore P(X_{t-1}|X_0)\sim N(\sqrt{\bar{a}_{t-1}}X_0,1-\sqrt{\bar{a}_{t-1}})\\åŒç†ï¼ŒP(X_{t}|X_0)\sim N(\sqrt{\bar{a}_{t}}X_0,1-\sqrt{\bar{a}_{t}})
$$
é‚£ä¹ˆ**ï¼ˆ5ï¼‰**ä¸­çš„è¿™ä¸‰é¡¹æˆ‘ä»¬å°±éƒ½æ±‚å‡ºæ¥å•¦ï¼ï¼ä¸€å®šå¯ä»¥ç»è¿‡è®¡ç®—å¾—åˆ°**ï¼ˆ5ï¼‰**è¿™ä¸ªå¼å­çš„åˆ†å¸ƒï¼š

è¿™é‡Œçœç•¥è®¡ç®—è¿‡ç¨‹ï¼š
$$
P(X_{t-1}|X_t,X_0)\sim N(F(X_0,X_t),G(a_t,\beta_t))
$$

1. å› ä¸ºFã€Gå‡½æ•°åˆ†åˆ«è¡¨ç¤ºNçš„å‡å€¼å’Œæ–¹å·®ï¼Œé‚£æˆ‘ä»¬ç»™ä»–ä¿©æ¢ä¸ªç¬¦å·å§ï¼
   $$
   F\rightarrow\mu,G\rightarrow\widehat{\beta}
   $$

2. å› ä¸º$\widehat\beta(a_t,\beta_t)$ä¸­çš„$a_tã€\beta_t$æ˜¯å®šå€¼ï¼Œæ‰€ä»¥$\widehat{\beta}$å®é™…ä¸Šä¹Ÿæ˜¯ä¸ªå¸¸æ•°

##### æœ€ç»ˆå…¬å¼

$$
P(X_{t-1}|X_t,X_0)\sim N(\mu(X_0,X_t),\widehat{\beta})
$$

æœªå®Œå¾…ç»­......